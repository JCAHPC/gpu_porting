---
title: GPU移行
description: GPU移行に関するポータルサイト
---

<details open markdown="block">
<summary>目次</summary>
- TOC
{:toc}
</details>

# 背景

（ここに OFP-IIのこともかく）

本サイトでは、皆様のコードをご自身でGPUへ移植するために、役立つ情報を集約しています。

# GPU移行に関する情報

## 移行の概要

既存のCPUコードをNVIDIA GPUへ移植して高い性能を得るために大事なことは、

- ループなどの計算の重い部分をCPUからGPUへ移植する
- 配列などのデータを極力GPU上のメモリだけに保持する（CPUとGPU間のデータ通信を極力減らす）

です。これに対して、どこまで性能を追求するか、開発コストをかけられるか、ソースコードのメンテナンス性を高めるかで、選択すべき移植方法が変わってきます。

既存のCPUコードをNVIDIA GPUへ移植するためには、いくつかの方法があり、代表的な方法は次のとおりです。
1番から3番に行くにつれて、達成できる性能は高くなる傾向にありますが、反対に開発効率が低下していきます。
OpenMP + MPIで並列化済みであれば、一般的には OpenACC + MPI へ移行することがおすすめです。

1. GPU対応ライブラリを用いる
2. コンパイラの支援を利用してGPU移植する
   - 既存のCPUコードにOpenACC指示文（ディレクティブ）を挿入する
   - 既存のCPUコードにOpenMP指示文（ディレクティブ）を挿入する
   - 標準言語の並列処理でGPUを利用する
3. GPU専用言語（CUDA）で書き換える

GPU計算の概要、NVIDIA GPU への移植方法についての比較は、下記の動画を参照ください。

- [GPUコンピューティングは難しいのか？](https://www.youtube.com/watch?v=pK-gllheNXE&t=22s)
- [An Introduction To GPU Programming Models](https://youtu.be/GKXG7OFTLzc?t=461)
- [A Deep Dive into the Latest HPC Software](https://www.nvidia.com/en-us/on-demand/session/gtcfall22-a41133/)

## GPUへの移植方法の特徴

### GPU対応ライブラリを用いる

特定のアルゴリズムについては、GPU向け（CUDA）ライブラリが存在しています。既存のCPU向けライブラリをGPU向けライブラリに入れ替えると、その部分のみですが、GPUで高速に計算されます。GPU向けライブラリとしては、下記のようなものがあります。OpenACCやCUDAとの併用は可能で、ライブラリで対応できない部分は、OpenACC などでGPU化する必要があります。

- cuFFT：フーリエ変換
- cuBLAS：行列演算（密行列）
- cuSPARSE：行列演算（疎行列）
- cuRAND：乱数生成
- Thrust：C++テンプレートライブラリ（STLベース）

### 既存のCPUコードにOpenACC指示文（ディレクティブ）を挿入する

OpenACC指示文（ディレクティブ）を既存のCPUコードに挿入することで、GPU向けコードをコンパイラが作成します。OpenACCは並列計算を容易に実現するもので、GPUを主な対象とし、C言語とFortranに対応しています。指示文で、ループ部分のGPU化、CPUとGPU間のデータ通信の挿入などを行うことができます。また、CUDAでは記述が複雑なリダクション計算もOpenACCでは簡単に記述できます。既存CPUコードに指示文を挿入するため、CPU向けのコードと共通化することが可能です。

詳細は下記の参考資料を参照ください。

- 動画など

### 既存のCPUコードにOpenMP指示文（ディレクティブ）を挿入する

OpenMP指示文（ディレクティブ）は、主に共有メモリ型マルチプロセッサの並列プログラミングに利用されます。OpenMP 4.0から、並列処理をGPUなどアクセラレータへオフロードする機能が提供されています（GPU Offloading）。OpenACCと同様なことがOpenMPでも実現できるようになりました。しかし、現時点では、NVIDIA GPUでは、OpenMP GPU Offloading よりもOpenACCの方が高い性能がでる傾向にあります。

詳細は下記の参考資料を参照ください。

- 動画など

### 標準言語の並列処理でGPUを利用する

最近のC++やFortranを利用することで、標準言語自体が提供する機能によって並列処理することができます。C++ではC++17以降に提供される並列プログラミングの機能でコードを記述することで、それをGPUで実行することができます。また、Fortran では、Fortran 2008 で並列プログラミングをサポートするための機能が追加され、Fortran 2018 ではその機能を強化されています。CPUとGPUのどちらからもアクセス可能なメモリ（Unified memory）と併用するため、明示的なメモリ転送は不要です。このため、ソースコードは完全に標準言語のみで記述可能で、高い移植性を実現できます。性能としては、明示的なメモリ転送ができないこと、細かいGPU実行の制御ができないこと、コンパイラが開発途上であることから、OpenACCよりも若干性能が劣る傾向にあります。

詳細は下記の参考資料を参照ください。

- [Developing HPC Applications with Standard C++, Fortran, and Python](https://www.nvidia.com/en-us/on-demand/session/gtcfall22-a41087/)

### CUDAで書き換える

CUDAはNVIDIA GPU向けの開発環境および言語であり、C++言語を拡張した CUDA C++ と Fortran を拡張した CUDA Fortran があります。ユーザがゼロからGPU向けコードを記述する必要があります。柔軟性が高く、高性能なコードを作成可能ですが、既存のCPUコードからの書き換え量は多く、生産性は高くありません。CUDAコードはCPU向けのコードとは別にメンテナンスする必要があり、コードの保守の観点でもコストが高いです。

詳細は下記の参考資料を参照ください。

- 動画など

# GPU移行実践

## 講習会

（GPU関連の講習会の一覧）

## ミニキャンプ

## 相談会

（相談会の開催予定と参加者のテーブルを掲載する）
